---
# roles/k8s/tasks/main.yaml

- name: 🧼 Remove /tmp/k8s if it exists (cleanup from previous runs)
  file:
    path: /tmp/k8s
    state: absent
  become: true

- name: 🏗️ Recreate /tmp/k8s with 0777 permissions so Jenkins can write
  file:
    path: /tmp/k8s
    state: directory
    mode: "0777"
  become: true

- name: 🔁 Rsync Kubernetes manifests to app node
  synchronize:
    src: "{{ playbook_dir }}/../k8s/staging/"
    dest: /tmp/k8s/
    recursive: yes
    compress: yes
  delegate_to: localhost
  become: false

- name: 📄 Copy nginx.conf to app node for ConfigMap
  copy:
    src: "{{ playbook_dir }}/../nginx/files/nginx.conf"
    dest: /tmp/k8s/nginx.conf
    mode: "0644"

- name: 🧱 Generate Nginx ConfigMap from nginx.conf
  shell: |
    kubectl create configmap qrgenix-nginx-config \
      --namespace=qrgenix \
      --from-file=nginx.conf=/tmp/k8s/nginx.conf \
      --dry-run=client -o yaml > /tmp/k8s/nginx-configmap.yaml
  args:
    chdir: /tmp/k8s
  become: false

- name: 🧾 Debug contents of /tmp/k8s
  shell: ls -l /tmp/k8s
  register: ls_output
  changed_when: false
  become: false

- name: 📤 Show /tmp/k8s contents
  debug:
    var: ls_output.stdout_lines

- name: 📦 Ensure qrgenix namespace exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: qrgenix
    state: present

- name: 📥 Apply nginx ConfigMap
  kubernetes.core.k8s:
    state: present
    src: /tmp/k8s/nginx-configmap.yaml

- name: 🚀 Apply remaining Kubernetes manifests
  kubernetes.core.k8s:
    state: present
    src: /tmp/k8s/

- name: 🧹 Clean up tmp folder
  file:
    path: /tmp/k8s/
    state: absent
  become: true
