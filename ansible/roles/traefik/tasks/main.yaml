# traefik main
- name: Clean up any existing /tmp/k8s/helm/ owned by root
  file:
    path: /tmp/k8s/helm/
    state: absent
  become: true

- name: Create namespace for Traefik
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: traefik
    state: present

- name: Ensure helm staging directory exists
  file:
    path: /tmp/k8s/helm
    state: directory
    mode: "0755"
  become: false

- name: Rsync Helm values files to app node
  synchronize:
    src: "{{ playbook_dir }}/../helm/"
    dest: /tmp/k8s/helm/
    recursive: yes
    compress: yes
  delegate_to: localhost
  become: false

- name: Add Traefik Helm repo
  command: helm repo add traefik https://traefik.github.io/charts
  args:
    creates: /root/.cache/helm/repository/traefik-index.yaml

- name: Update Helm repos
  command: helm repo update

- name: Deploy Traefik via Helm
  command: >
    helm install traefik traefik/traefik
    --namespace traefik
    --create-namespace
    -f /tmp/k8s/helm/traefik-values.yaml
  become: true

- name: Clean up Helm files
  file:
    path: /tmp/k8s/helm/
    state: absent
  become: true
